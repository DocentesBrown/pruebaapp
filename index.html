<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo en Vivo</title>
    <style>
        :root { --primary: #008069; --accent: #e53935; --bg: #f0f2f5; --card: #ffffff; --text: #333; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; }
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;}
        .store-name { font-size: 1.4rem; font-weight: bold; }
        
        .loading { text-align: center; margin-top: 50px; color: #666; font-style: italic; }
        
        /* CATEGOR√çAS */
        .cat-scroll { display: flex; overflow-x: auto; padding: 15px 10px; gap: 10px; background: var(--bg); white-space: nowrap; }
        .cat-btn { padding: 8px 16px; border-radius: 20px; background: white; border: 1px solid #ddd; cursor: pointer; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        /* GRILLA */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 15px; }
        .card { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; }
        .card.no-stock { opacity: 0.6; filter: grayscale(100%); pointer-events: none; }
        
        .card-img-container { position: relative; width: 100%; height: 160px; }
        .card-img { width: 100%; height: 100%; object-fit: cover; background: #eee; }
        .badge { position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.7rem; font-weight: bold; }
        .badge-promo { background: var(--accent); }
        .badge-stock { background: #555; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; padding: 10px 20px; border-radius: 8px; }

        .card-body { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-weight: 600; margin: 0 0 5px 0; font-size: 0.95rem; }
        .price-old { text-decoration: line-through; color: #999; font-size: 0.8rem; margin-right: 5px; }
        .price-curr { color: var(--primary); font-weight: bold; font-size: 1.1rem; }
        .price-promo { color: var(--accent); }
        
        .add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 10px; border-radius: 8px; margin-top: auto; cursor: pointer; font-weight: 500; }

        /* CARRITO */
        .cart-float { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 15px 25px; border-radius: 50px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); cursor: pointer; width: 85%; max-width: 350px; justify-content: space-between; z-index: 200; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-whatsapp { background: #25D366; color: white; text-align: center; padding: 15px; border-radius: 12px; display: block; text-decoration: none; font-weight: bold; margin-top: 20px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <header>
        <div class="store-name">Mi Tienda Online</div>
    </header>

    <div id="loading" class="loading">‚è≥ Conectando con tu cat√°logo...</div>

    <div class="cat-scroll" id="catContainer"></div>
    <div class="grid" id="productGrid"></div>

    <div class="cart-float" onclick="openCart()" id="cartBtn" style="display: none;">
        <span>üõí <span id="cartCount">0</span></span> <b id="cartTotal">$0</b>
    </div>

    <div class="modal" id="cartModal" onclick="if(event.target === this) closeCart()">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between;"><h2>Tu Pedido</h2><span onclick="closeCart()" style="font-size:1.5rem;cursor:pointer;">‚úï</span></div>
            <div id="cartItemsList"></div>
            <h3>Total: <span id="modalTotal">$0</span></h3>
            <a href="#" id="waLink" class="btn-whatsapp" target="_blank">Enviar Pedido</a>
            <button onclick="clearCart()" style="width:100%; margin-top:10px; border:none; background:none; color:#999; text-decoration:underline;">Vaciar Carrito</button>
        </div>
    </div>

    <script>
        // ======================================================
        //  TUS DATOS
        // ======================================================
        
        // 1. TU HOJA DE GOOGLE (Ya integrada)
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIeeh6NdE-R9juaWpgnQdZgy5ArrQKZ_A_nDJ2tMV9hjskZ0bp0FJeZHpQzM8a5S03tq-u5J2pLBVS/pub?output=csv";
        
        // 2. TU N√öMERO DE WHATSAPP (¬°C√ÅMBIALO!)
        // Formato: 549 + Area + Numero. Ejemplo: 5491122334455
        const PHONE_NUMBER = "5491122334455"; 

        // ======================================================

        let products = [];
        let cart = [];
        let activeCategory = 'all';

        async function init() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                products = parseCSV(text);
                
                document.getElementById('loading').style.display = 'none';
                renderCategories();
                renderProducts('all');

            } catch (error) {
                document.getElementById('loading').innerText = "Hubo un error al leer la hoja de c√°lculo. Verifica que est√© publicada en la Web.";
                console.error(error);
            }
        }

        // Funci√≥n para leer el CSV de Google
        function parseCSV(csvText) {
            const rows = csvText.split('\n').map(row => row.trim()).filter(row => row.length > 0);
            const headers = rows.shift().split(','); // Quitamos la fila 1 (t√≠tulos)
            
            return rows.map(row => {
                const values = row.split(','); 
                
                // Mapeo seguro: id, nombre, precio, promo, categoria, imagen, stock
                // Si tu hoja tiene otro orden, esto podr√≠a fallar.
                return {
                    id: values[0] || Date.now(),
                    name: values[1] || "Sin Nombre",
                    price: parseFloat(values[2]) || 0,
                    promoPrice: values[3] ? parseFloat(values[3]) : null,
                    cat: values[4] || "Varios",
                    img: values[5] || "",
                    hasStock: (values[6] || "").toUpperCase().includes('SI')
                };
            });
        }

        /* --- RENDER --- */
        function renderCategories() {
            const cats = ['Todos', ...new Set(products.map(p => p.cat))];
            const c = document.getElementById('catContainer');
            c.innerHTML = ''; 
            cats.forEach(x => {
                const key = x === 'Todos' ? 'all' : x;
                c.innerHTML += `<button class="cat-btn ${activeCategory===key?'active':''}" onclick="filter('${key}')">${x}</button>`;
            });
        }

        function filter(cat) { activeCategory = cat; renderCategories(); renderProducts(cat); }

        function renderProducts(filter) {
            const g = document.getElementById('productGrid');
            g.innerHTML = '';
            const list = filter === 'all' ? products : products.filter(p => p.cat === filter);
            
            if(list.length === 0) {
                 g.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#999">No hay productos en esta categor√≠a.</p>';
                 return;
            }

            list.forEach(p => {
                const isPromo = p.promoPrice && p.promoPrice < p.price;
                const priceDisplay = isPromo 
                    ? `<span class="price-old">$${p.price}</span> <span class="price-curr price-promo">$${p.promoPrice}</span>`
                    : `<span class="price-curr">$${p.price}</span>`;
                
                g.innerHTML += `
                    <div class="card ${!p.hasStock?'no-stock':''}">
                        <div class="card-img-container">
                            ${isPromo ? '<div class="badge badge-promo">OFERTA</div>' : ''}
                            ${!p.hasStock ? '<div class="badge badge-stock">AGOTADO</div>' : ''}
                            <img src="${p.img}" class="card-img" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">
                        </div>
                        <div class="card-body">
                            <h4 class="card-title">${p.name}</h4>
                            <div class="price-container">${priceDisplay}</div>
                            <button class="add-btn" onclick="addToCart('${p.id}')" ${!p.hasStock?'disabled':''}>${p.hasStock?'Agregar':'Sin Stock'}</button>
                        </div>
                    </div>`;
            });
        }

        /* --- CART --- */
        function addToCart(id) {
            const p = products.find(x => x.id === id);
            if(p && p.hasStock) { cart.push(p); updateCart(); }
        }
        function updateCart() {
            const tot = cart.reduce((s, i) => s + (i.promoPrice||i.price), 0);
            document.getElementById('cartCount').innerText = cart.length;
            document.getElementById('cartTotal').innerText = '$' + tot;
            document.getElementById('modalTotal').innerText = '$' + tot;
            document.getElementById('cartBtn').style.display = cart.length ? 'flex' : 'none';
        }
        function openCart() {
            const lst = document.getElementById('cartItemsList'); lst.innerHTML = '';
            const grp = {};
            cart.forEach(i => { if(!grp[i.id]) grp[i.id]={...i,c:0}; grp[i.id].c++; });
            let msg = "Hola! Quiero pedir:%0A";
            Object.values(grp).forEach(i => {
                const pr = i.promoPrice||i.price;
                lst.innerHTML += `<div class="cart-item"><span>${i.name} (x${i.c})</span><b>$${pr*i.c}</b></div>`;
                msg += `- ${i.name} (x${i.c}): $${pr*i.c}%0A`;
            });
            msg += `%0ATotal: $${cart.reduce((s,x)=>s+(x.promoPrice||x.price),0)}`;
            document.getElementById('waLink').href = `https://wa.me/${PHONE_NUMBER}?text=${msg}`;
            document.getElementById('cartModal').style.display = 'flex';
        }
        function closeCart() { document.getElementById('cartModal').style.display = 'none'; }
        function clearCart() { cart=[]; updateCart(); closeCart(); }

        init();
    </script>
</body>
</html>
