<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mi Tienda</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #007AFF; --accent: #FF3B30; --bg: #F2F2F7;
            --card: #FFFFFF; --text: #000000; --text-sec: #8E8E93;
            --radius: 12px; --max-width: 1100px;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 100px; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }

        /* LAYOUT PC */
        .app-container { max-width: var(--max-width); margin: 0 auto; min-height: 100vh; }

        /* HEADER */
        header { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 15px 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #e5e5e5; }
        .header-content { width: 100%; max-width: var(--max-width); margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 800; font-size: 1.4rem; }
        .btn-icon { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--primary); }
        .btn-text { background: none; border: none; font-size: 1rem; font-weight: 600; color: var(--primary); cursor: pointer; }

        /* SIDEBAR Y BOTONES BONITOS */
        .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: white; z-index: 2000; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .sidebar.open { left: 0; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1999; display:none; opacity:0; transition:0.3s; }
        .overlay.open { display:block; opacity:1; }
        .sidebar-head { padding: 20px; display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:1.2rem; border-bottom:1px solid #eee; }
        .sidebar-body { flex:1; overflow-y:auto; padding:10px; }
        .sidebar-item { padding:15px; border-radius:10px; margin-bottom:5px; cursor:pointer; color:#333; transition:0.2s; font-weight: 500; }
        .sidebar-item:hover, .sidebar-item.active { background: #f0f7ff; color: var(--primary); }
        
        .sidebar-foot { padding:20px; border-top:1px solid #eee; }
        /* Estilos de botones de contacto recuperados */
        .contact-btn { display: flex; align-items: center; gap: 15px; text-decoration: none; color: #333; margin-bottom: 12px; padding: 15px; background: white; border-radius: 12px; border: 2px solid #eee; font-weight: 700; transition: 0.2s; }
        .contact-btn.wa { color: #25D366; border-color: #25D366; } .contact-btn.wa:hover { background: #eafff0; }
        .contact-btn.ig { color: #E1306C; border-color: #E1306C; } .contact-btn.ig:hover { background: #fff0f5; }
        .contact-btn span { font-size: 1.5rem; }

        /* ADMIN PANEL */
        #adminPanel { display: none; padding: 25px; background: white; margin: 20px; border-radius: var(--radius); box-shadow: 0 4px 25px rgba(0,0,0,0.05); }
        .admin-visible #adminPanel { display: block; animation: fadeDown 0.3s; }
        @keyframes fadeDown { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
        .form-grid { display: grid; gap: 15px; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
        input, textarea, select { width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 10px; font-size: 16px; box-sizing: border-box; font-family: inherit; background: #f9f9f9; }
        input:focus, textarea:focus { border-color: var(--primary); background: white; outline: none; }
        .photo-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .btn-photo { background: #f0f7ff; border: 2px dashed var(--primary); border-radius: 12px; padding: 25px; cursor: pointer; text-align: center; color: var(--primary); font-weight: 600; transition:0.2s; }
        .btn-photo:hover, .btn-photo:active { background: var(--primary); color: white; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,122,255,0.3); }
        .btn-sec { background: #f2f2f7; color: #333; margin-top: 10px; }
        .btn-danger { background: #ff3b30; color: white; margin-top: 20px; }

        /* CATEGORIAS Y GRILLA */
        .cat-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 20px; scrollbar-width: none; background: var(--bg); }
        .cat-pill { background: white; padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition:0.2s; color: #666; }
        .cat-pill.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }

        .grid { display: grid; padding: 20px; gap: 20px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); } }

        .card { background: white; border-radius: var(--radius); overflow: hidden; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; display: flex; flex-direction: column; }
        @media (min-width: 1024px) { .card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); } }
        .card.no-stock { opacity: 0.6; filter: grayscale(0.5); }
        /* Animaci√≥n para Link Directo */
        @keyframes flashHighlight { 0%, 100% {box-shadow: 0 4px 15px rgba(0,0,0,0.05);} 50% {box-shadow: 0 0 0 4px var(--primary), 0 15px 40px rgba(0,122,255,0.4); transform: scale(1.02);} }
        .highlight-card { animation: flashHighlight 1.5s ease-in-out 2; z-index: 10; }

        .img-wrap { width: 100%; aspect-ratio: 1/1; position: relative; background: #f0f0f0; }
        .img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .badge { position: absolute; top: 12px; left: 12px; padding: 6px 10px; border-radius: 6px; color: white; font-size: 0.75rem; font-weight: 800; backdrop-filter: blur(4px); }
        .bg-promo { background: var(--accent); } .bg-stock { background: rgba(0,0,0,0.7); top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 1.1rem; }

        .card-info { padding: 15px; display:flex; flex-direction:column; flex-grow:1; }
        .c-title { font-weight: 700; margin-bottom: 6px; color: var(--text); font-size: 1.1rem; }
        .c-desc { font-size: 0.9rem; color: var(--text-sec); margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* --- NUEVO: VARIANTES --- */
        .variants-wrap { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .var-pill { padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: #666; cursor: pointer; transition: 0.2s; }
        .var-pill.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .c-footer { margin-top: auto; display: flex; align-items: center; justify-content: space-between; }
        .c-price { font-weight: 800; font-size: 1.3rem; }
        .old-p { text-decoration: line-through; color: var(--text-sec); font-size: 0.9rem; margin-right: 6px; }
        .btn-add { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .btn-add:active { transform: scale(0.9); } .card.no-stock .btn-add { background: #ccc; box-shadow: none; }
        
        .card-actions { position: absolute; top:10px; right:10px; display:none; gap:8px; z-index: 20; }
        .admin-visible .card-actions { display:flex; }
        .act-btn { width:36px; height:36px; border-radius:50%; background:white; border:none; box-shadow:0 4px 10px rgba(0,0,0,0.1); cursor:pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }

        /* DOCK & MODALES (Igual que antes) */
        .dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1c1c1e; color: white; padding: 15px 30px; border-radius: 40px; display: flex; align-items: center; gap: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); cursor: pointer; z-index: 500; transition: 0.3s; width: auto; min-width: 280px; justify-content: space-between; }
        .dock:hover { transform: translateX(-50%) scale(1.05); }
        .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; animation: popUp 0.3s; }
        @keyframes popUp { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
        @media (max-width: 768px) { .modal-bg { align-items: flex-end; } .modal-box { border-radius: 30px 30px 0 0; max-width: 100%; padding: 30px 25px 50px 25px; animation: slideUp 0.3s; } @keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} } }
        .close-btn { position: absolute; top: 20px; right: 20px; border: none; background: #f2f2f7; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; color: #666; }
        .cart-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 1.1rem; }
        .wa-btn { display: block; background: #25D366; color: white; text-align: center; padding: 18px; border-radius: 15px; text-decoration: none; font-weight: 800; margin-top: 25px; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2); }
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:4000; display:flex; justify-content:center; align-items:center; }
        .spinner { width:50px; height:50px; border:5px solid #ddd; border-top:5px solid var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }

    </style>
</head>
<body id="mainBody">

    <div id="loader"><div class="spinner"></div></div>

    <div class="app-container">
        <header>
            <div class="header-content">
                <button class="btn-icon" onclick="toggleMenu()">‚ò∞</button>
                <div class="brand">Mi Tienda</div>
                <button class="btn-text" onclick="checkLoginAccess()">Admin</button>
            </div>
        </header>

        <div class="overlay" id="menuOverlay" onclick="toggleMenu()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-head">Men√∫ <button class="btn-icon" onclick="toggleMenu()">‚úï</button></div>
            <div class="sidebar-body" id="sidebarList"></div>
            <div class="sidebar-foot">
                <a href="#" id="waContact" target="_blank" class="contact-btn wa">
                    <span>üí¨</span> WhatsApp
                </a>
                <a href="#" id="igContact" target="_blank" class="contact-btn ig">
                    <span>üì∏</span> Instagram
                </a>
            </div>
        </div>

        <div id="adminPanel">
            <div style="display:flex; justify-content:space-between; margin-bottom:25px;">
                <h2 style="margin:0;">Gesti√≥n</h2>
                <button class="btn-text" onclick="togglePassMode(true)">Cambiar Clave</button>
            </div>
            <input type="hidden" id="editId">
            
            <div class="form-grid">
                <input type="text" id="pName" placeholder="Nombre del Producto">
                <input type="text" id="pCat" placeholder="Categor√≠a" list="catDatalist">
            </div>
            <textarea id="pDesc" placeholder="Descripci√≥n..." style="margin-top:15px; height:80px;"></textarea>
            <input type="text" id="pVars" placeholder="Variantes separadas por coma (Ej: S, M, L o Rojo, Azul)" style="margin-top:15px; background:#fffbe6; border-color:#ffe58f;">
            
            <div class="form-grid" style="margin-top:15px;">
                <input type="number" id="pPrice" placeholder="Precio ($)">
                <input type="number" id="pPromo" placeholder="Promo (Opcional)">
            </div>
            
            <div class="photo-area">
                <div class="btn-photo" onclick="document.getElementById('fileInputCam').click()">üì∏ C√ÅMARA</div>
                <div class="btn-photo" onclick="document.getElementById('fileInputGal').click()">üñºÔ∏è GALER√çA</div>
            </div>
            <div id="uploadStatus" style="text-align:center; color:#666; font-weight:600; margin-bottom:20px;">Sube una foto</div>

            <input type="file" id="fileInputCam" accept="image/*" capture="environment" onchange="uploadToDrive(this)" style="display:none;">
            <input type="file" id="fileInputGal" accept="image/*" onchange="uploadToDrive(this)" style="display:none;">
            <input type="hidden" id="pImg">

            <select id="pStock"><option value="SI">‚úÖ Hay Stock</option><option value="NO">‚ùå Agotado</option></select>
            <datalist id="catDatalist"></datalist>

            <div class="form-grid" style="margin-top:25px;">
                <button class="btn btn-primary" onclick="saveProductToServer()" id="btnSave">GUARDAR</button>
                <button class="btn btn-sec" onclick="cancelEdit()" id="btnCancel" style="display:none">CANCELAR</button>
            </div>
            <button class="btn btn-danger" onclick="logout()">CERRAR SESI√ìN</button>
        </div>

        <div class="cat-scroll" id="catContainer"></div>
        <div class="grid" id="grid"></div>
    </div>

    <div class="dock" id="cartBtn" onclick="openCart()" style="display:none;">
        <span>üõçÔ∏è Mi Pedido (<span id="cartCount">0</span>)</span>
        <span id="cartTotal" style="font-weight:bold">$0</span>
    </div>

    <div class="modal-bg" id="cartModal" onclick="if(event.target===this)closeCart()">
        <div class="modal-box">
            <button class="close-btn" onclick="closeCart()">‚úï</button>
            <h2>Tu Carrito</h2>
            <div id="cartList" style="margin-top:25px; max-height:40vh; overflow-y:auto;"></div>
            <h3 style="text-align:right; margin-top:25px; font-size:1.5rem;">Total: <span id="modalTotal">$0</span></h3>
            <button onclick="finalizeOrder()" class="btn wa-btn" id="waBtn">FINALIZAR PEDIDO POR WHATSAPP</button>
            <button onclick="clearCart()" class="btn-text" style="width:100%; margin-top:15px; color:#999;">Vaciar Carrito</button>
        </div>
    </div>

    <div class="modal-bg" id="loginModal">
        <div class="modal-box" id="loginFormBox">
            <button class="close-btn" onclick="closeLogin()">‚úï</button>
            <h2>Acceso Admin</h2>
            <input type="text" id="loginUser" placeholder="Usuario" style="margin-bottom:15px;">
            <input type="password" id="loginPass" placeholder="Contrase√±a" style="margin-bottom:25px;">
            <button class="btn btn-primary" onclick="doLogin()">Entrar</button>
        </div>
        <div class="modal-box" id="changePassBox" style="display:none;">
            <button class="close-btn" onclick="togglePassMode(false)">‚úï</button>
            <h2>Nueva Clave</h2>
            <input type="password" id="oldPass" placeholder="Clave Actual" style="margin-bottom:15px;">
            <input type="password" id="newPass" placeholder="Nueva Clave" style="margin-bottom:15px;">
            <input type="password" id="confirmPass" placeholder="Confirmar" style="margin-bottom:25px;">
            <button class="btn btn-primary" onclick="saveNewPass()">Guardar</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxMUSMKycILcGWQVbUbAy7MtgvvvWhM0-QdlMdp4sXxirDHKz-LvaQgaYuku3Td8puS4Q/exec";
        const PHONE = "5491138614767"; 
        const INSTAGRAM_URL = "https://instagram.com/TU_USUARIO"; 

        let products = [], cart = [], activeCat = 'all';
        let isLoggedIn = false;
        let selectedVariants = {}; // Almacena la variante seleccionada por producto

        function getCreds() { const s = localStorage.getItem('shop_creds'); return s ? JSON.parse(s) : { u: 'LUCAS', p: 'FAGA' }; }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('menuOverlay').classList.toggle('open');
        }

        function checkLoginAccess() { 
            if (isLoggedIn) {
                document.getElementById('mainBody').classList.toggle('admin-visible');
                window.scrollTo(0,0);
            } else {
                document.getElementById('loginModal').style.display='flex';
                document.getElementById('loginFormBox').style.display='block';
                document.getElementById('changePassBox').style.display='none';
            }
        }
        function doLogin() {
            const u = document.getElementById('loginUser').value, p = document.getElementById('loginPass').value, c = getCreds();
            if (u === c.u && p === c.p) { isLoggedIn = true; closeLogin(); document.getElementById('mainBody').classList.add('admin-visible'); } else alert("Datos incorrectos");
        }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }
        function logout() { isLoggedIn = false; document.getElementById('mainBody').classList.remove('admin-visible'); alert("Sesi√≥n cerrada"); }
        function togglePassMode(show) { document.getElementById('loginFormBox').style.display = show?'none':'block'; document.getElementById('changePassBox').style.display = show?'block':'none'; }
        function saveNewPass() {
            const o = document.getElementById('oldPass').value, n = document.getElementById('newPass').value, c = document.getElementById('confirmPass').value, r = getCreds();
            if (o !== r.p) return alert("Actual incorrecta"); if (n !== c) return alert("No coinciden"); if (n.length<4) return alert("Muy corta");
            localStorage.setItem('shop_creds', JSON.stringify({ u: 'LUCAS', p: n })); alert("Listo"); closeLogin();
        }

        function uploadToDrive(input) {
            const file = input.files[0]; const status = document.getElementById('uploadStatus');
            if(!file) return; if(file.size>5*1024*1024) return alert("M√°ximo 5MB");
            status.innerText = "‚è≥ Subiendo..."; status.style.color = "var(--primary)";
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async function() {
                try {
                    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "uploadImage", image: reader.result.split(',')[1], mimeType: file.type, filename: file.name }) });
                    const data = await res.json();
                    if(data.result === "success") { document.getElementById('pImg').value = data.url; status.innerText = "‚úÖ Foto lista"; status.style.color = "#34C759"; } else throw new Error();
                } catch(e) { status.innerText = "‚ùå Error al subir"; status.style.color = "red"; }
            };
        }

        async function init() {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('waContact').href = `https://wa.me/${PHONE}`; document.getElementById('igContact').href = INSTAGRAM_URL;
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                products = data.products || [];
                renderCats(); renderGrid('all');
                checkDeepLink(); // REVISAR SI HAY LINK DIRECTO
            } catch (err) { alert("Error conectando"); } finally { document.getElementById('loader').style.display = 'none'; }
        }

        // --- NUEVA FUNCI√ìN: DEEP LINKING ---
        function checkDeepLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            if (productId) {
                const productCard = document.getElementById('product-' + productId);
                if (productCard) {
                    // Scroll suave hasta el producto
                    productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // A√±adir clase para efecto de resaltado
                    productCard.classList.add('highlight-card');
                    // Quitar el efecto despu√©s de unos segundos
                    setTimeout(() => { productCard.classList.remove('highlight-card'); }, 3000);
                }
            }
        }

        async function saveProductToServer() {
            const img = document.getElementById('pImg').value, name = document.getElementById('pName').value, price = document.getElementById('pPrice').value;
            if(!name || !price) return alert("Falta nombre/precio"); if(!img) return alert("Falta foto");
            document.getElementById('loader').style.display = 'flex';
            const payload = {
                action: document.getElementById('editId').value ? "edit" : "add",
                id: document.getElementById('editId').value || Date.now(),
                name: name, price: price, promo: document.getElementById('pPromo').value,
                img: img, cat: document.getElementById('pCat').value || "Varios",
                stock: document.getElementById('pStock').value, 
                desc: document.getElementById('pDesc').value,
                vars: document.getElementById('pVars').value // NUEVO CAMPO VARIANTES
            };
            try { await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }); cancelEdit(); await init(); } catch(e) { alert("Error"); } finally { document.getElementById('loader').style.display = 'none'; }
        }

        async function deleteProduct(id) {
            if(!confirm("¬øBorrar?")) return; document.getElementById('loader').style.display = 'flex';
            try { await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "delete", id: id }) }); await init(); } catch(e) {} finally { document.getElementById('loader').style.display = 'none'; }
        }

        function renderCats() {
            const cats = ['Todos', ...new Set(products.map(p => p.cat))];
            const c = document.getElementById('catContainer'); const sb = document.getElementById('sidebarList');
            c.innerHTML = ''; sb.innerHTML = '';
            cats.forEach(x => { 
                const cls = activeCat===x ? 'active' : '';
                c.innerHTML += `<div class="cat-pill ${cls}" onclick="filter('${x==='Todos'?'all':x}')">${x}</div>`;
                sb.innerHTML += `<div class="sidebar-item ${cls}" onclick="filter('${x==='Todos'?'all':x}'); toggleMenu()">${x}</div>`;
            });
        }
        
        function filter(c) { activeCat=c; renderCats(); renderGrid(c); }
        
        function renderGrid(c) {
            const g = document.getElementById('grid'); g.innerHTML = '';
            const list = c === 'all' ? products : products.filter(p => p.cat === c);
            if(list.length === 0) { g.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#999; margin-top:50px;">Sin productos</p>'; return; }
            list.forEach(p => {
                const isPromo = p.promoPrice && p.promoPrice < p.price;
                // LOGICA PARA GENERAR BOTONES DE VARIANTES
                let variantsHtml = '';
                if (p.vars) {
                    const varList = p.vars.split(',').map(v => v.trim());
                    variantsHtml = '<div class="variants-wrap">';
                    varList.forEach(v => {
                        variantsHtml += `<div class="var-pill" onclick="selectVariant(this, ${p.id}, '${v}')">${v}</div>`;
                    });
                    variantsHtml += '</div>';
                }

                // Agregamos ID al container de la card para el Deep Linking
                g.innerHTML += `
                <div class="card ${!p.hasStock?'no-stock':''}" id="product-${p.id}">
                    <div class="card-actions"><button class="act-btn" onclick='editP(${JSON.stringify(p)})'>‚úèÔ∏è</button><button class="act-btn btn-del" onclick="deleteProduct(${p.id})">üóëÔ∏è</button></div>
                    <div class="img-wrap">${isPromo?'<span class="badge bg-promo">OFERTA</span>':''}${!p.hasStock?'<span class="badge bg-stock">AGOTADO</span>':''}<img src="${p.img}"></div>
                    <div class="card-info">
                        <div class="c-title">${p.name}</div>
                        ${p.desc ? `<div class="c-desc">${p.desc}</div>` : ''}
                        ${variantsHtml}
                        <div class="c-footer">
                            <div class="prices">${isPromo ? `<span class="old-p">$${p.price}</span> <span class="promo">$${p.promoPrice}</span>` : `$${p.price}`}</div>
                            <button class="btn-add" onclick="addCart(${p.id})" ${!p.hasStock?'disabled':''}>${p.hasStock?'+':'‚úï'}</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // NUEVA FUNCI√ìN: SELECCIONAR VARIANTE
        function selectVariant(btn, productId, variantName) {
            // Quitar selecci√≥n previa visualmente en este producto
            const parent = btn.parentElement;
            parent.querySelectorAll('.var-pill').forEach(b => b.classList.remove('selected'));
            // Marcar el nuevo
            btn.classList.add('selected');
            // Guardar la selecci√≥n
            selectedVariants[productId] = variantName;
        }
        
        function editP(p) {
            if(!isLoggedIn) return checkLoginAccess();
            document.getElementById('editId').value = p.id;
            document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pPromo').value = p.promoPrice||'';
            document.getElementById('pImg').value = p.img; document.getElementById('pCat').value = p.cat; document.getElementById('pStock').value = p.hasStock?'SI':'NO'; document.getElementById('pDesc').value = p.desc || ''; 
            document.getElementById('pVars').value = p.vars || ''; // Cargar variantes al editar
            document.getElementById('uploadStatus').innerText = "‚úÖ Foto OK"; document.getElementById('btnSave').innerText = "Actualizar"; document.getElementById('btnCancel').style.display = 'block';
            document.getElementById('mainBody').classList.add('admin-visible'); window.scrollTo(0,0);
        }
        function cancelEdit() {
            document.getElementById('editId').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pPromo').value = '';
            document.getElementById('pImg').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pVars').value = '';
            document.getElementById('btnSave').innerText = "Guardar"; document.getElementById('btnCancel').style.display = 'none';
            document.getElementById('uploadStatus').innerText = "Sube una foto";
        }
        
        // LOGICA CARRITO MODIFICADA PARA VARIANTES
        function addCart(id) { 
            const p = products.find(x=>x.id==id); 
            if(p && p.hasStock){ 
                // Verificar si requiere variante y si se seleccion√≥
                if (p.vars && !selectedVariants[id]) {
                    alert("Por favor, selecciona una opci√≥n (Talle/Color) antes de agregar.");
                    return;
                }
                
                // Crear un item para el carrito (clonando el producto)
                let cartItem = {...p};
                // Si tiene variante seleccionada, modificar el nombre para el carrito
                if (selectedVariants[id]) {
                    cartItem.name = `${p.name} (${selectedVariants[id]})`;
                    // Limpiar selecci√≥n despu√©s de agregar
                    delete selectedVariants[id];
                    // Resetear visualmente los botones
                    const productCard = document.getElementById('product-' + id);
                    if(productCard) {
                        productCard.querySelectorAll('.var-pill').forEach(b => b.classList.remove('selected'));
                    }
                }

                cart.push(cartItem); 
                updateCart(); 
            } 
        }

        function updateCart() {
            const t = cart.reduce((a,b)=>a+(b.promoPrice||b.price),0);
            document.getElementById('cartTotal').innerText = '$'+t; document.getElementById('modalTotal').innerText = '$'+t;
            document.getElementById('cartCount').innerText = cart.length;
            document.getElementById('cartBtn').style.display = cart.length?'flex':'none';
        }
        function openCart() {
            const l = document.getElementById('cartList'); l.innerHTML = ''; const g = {}; 
            // Agrupar por nombre exacto (incluyendo la variante)
            cart.forEach(i=>{ if(!g[i.name])g[i.name]={...i,q:0}; g[i.name].q++; });
            Object.values(g).forEach(i=>{ const pr = i.promoPrice||i.price; l.innerHTML+=`<div class="cart-row"><span>${i.name} (x${i.q})</span><b>$${pr*i.q}</b></div>`; });
            document.getElementById('cartModal').style.display='flex';
        }
        function closeCart(){document.getElementById('cartModal').style.display='none';}
        function clearCart(){cart=[];updateCart();closeCart();}

        // NUEVA FUNCI√ìN: FINALIZAR PEDIDO (REGISTRA VENTA Y ABRE WA)
        async function finalizeOrder() {
            const waBtn = document.getElementById('waBtn');
            waBtn.innerText = "Registrando pedido..."; 
            waBtn.disabled = true;

            // 1. Preparar mensaje de WhatsApp y datos para la Hoja
            const g = {}; cart.forEach(i=>{ if(!g[i.name])g[i.name]={...i,q:0}; g[i.name].q++; });
            let waMsg = "Hola! Quiero pedir:%0A%0A";
            let sheetDetails = "";
            
            Object.values(g).forEach(i=>{ 
                const pr = i.promoPrice||i.price; 
                waMsg += `‚Ä¢ *${i.q}x ${i.name}*: $${pr*i.q}%0A`; 
                sheetDetails += `${i.q}x ${i.name} ($${pr*i.q}) | `;
            });
            
            const total = cart.reduce((a,b)=>a+(b.promoPrice||b.price),0);
            waMsg += `%0Aüí∞ *TOTAL: $${total}*`;

            // 2. Enviar datos a Google Sheet (CRM) en segundo plano
            try {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "recordSale",
                        orderDetails: sheetDetails,
                        total: total
                    })
                });
            } catch (e) {
                console.error("Error registrando venta en hoja, pero se abrir√° WA", e);
            }

            // 3. Abrir WhatsApp
            window.open(`https://wa.me/${PHONE}?text=${waMsg}`, '_blank');
            
            // 4. Limpiar y cerrar
            clearCart();
            waBtn.innerText = "FINALIZAR PEDIDO POR WHATSAPP"; 
            waBtn.disabled = false;
        }

        init();
    </script>
</body>
</html>
