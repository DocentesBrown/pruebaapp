<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Mi Tienda</title>
    <style>
        /* --- VARIABLES ESTILO IOS --- */
        :root {
            --primary: #007AFF; /* Azul iOS */
            --brand-color: #008069; /* Tu verde original para la marca */
            --accent: #FF3B30; /* Rojo iOS */
            --bg: #F2F2F7; /* Fondo gris claro iOS */
            --card: #FFFFFF;
            --text: #000000;
            --text-secondary: #8E8E93;
            --separator: #C6C6C8;
            --sidebar-width: 300px;
            --radius-l: 16px;
            --radius-m: 12px;
            --radius-s: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            /* Padding seguro para el notch y la barra inferior */
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER NATIVO --- */
        header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text);
            padding: 12px 16px;
            position: sticky;
            top: 0; /* Se ajusta debajo del notch */
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid var(--separator);
            height: 44px; /* Altura est√°ndar iOS */
        }
        .brand { font-weight: 700; font-size: 1.4rem; color: var(--text); letter-spacing: -0.5px; text-align: center; flex-grow: 1; }
        .header-btn { background: none; border: none; color: var(--primary); font-size: 1rem; font-weight: 500; cursor: pointer; padding: 8px 0; transition: opacity 0.2s; }
        .header-btn:active { opacity: 0.5; }
        .menu-icon { font-size: 1.5rem; color: var(--primary); }

        /* --- SIDEBAR (MENU) --- */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1999; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .menu-overlay.open { display: block; opacity: 1; }
        
        .sidebar { 
            position: fixed; top: 0; left: calc(var(--sidebar-width) * -1); width: var(--sidebar-width); height: 100%; 
            background: var(--bg); z-index: 2000; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            display: flex; flex-direction: column; box-shadow: 2px 0 12px rgba(0,0,0,0.1); 
            padding-top: env(safe-area-inset-top);
        }
        .sidebar.open { transform: translateX(var(--sidebar-width)); }
        
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 1.8rem; display: flex; justify-content: space-between; align-items: center; color: var(--text); background: var(--card); }
        .close-menu { background: none; border: none; color: var(--separator); font-size: 1.5rem; cursor: pointer; }
        
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .sidebar-group { background: var(--card); border-radius: var(--radius-m); overflow: hidden; margin-bottom: 20px; }
        .sidebar-item { padding: 16px 20px; border-bottom: 0.5px solid var(--separator); cursor: pointer; font-size: 1.1rem; color: var(--text); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-item:last-child { border-bottom: none; }
        .sidebar-item:active { background: #E5E5EA; }
        .sidebar-item.active { color: var(--primary); font-weight: 600; }
        .sidebar-item::after { content: '‚Ä∫'; color: var(--separator); font-weight: 300; font-size: 1.4rem; }
        
        .sidebar-footer { padding: 20px; background: var(--bg); }
        .contact-link { display: flex; align-items: center; gap: 12px; text-decoration: none; color: white; margin-bottom: 12px; padding: 14px; border-radius: var(--radius-m); font-weight: 600; font-size: 1.1rem; justify-content: center; }
        .contact-link.wa { background: #25D366; }
        .contact-link.ig { background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); }

        /* --- ADMIN PANEL (Estilo Formulario iOS) --- */
        #adminPanel { display: none; background: var(--bg); padding: 20px; animation: slideDown 0.3s ease-out; }
        .admin-visible #adminPanel { display: block; }
        @keyframes slideDown { from {transform: translateY(-30px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .form-group { background: var(--card); border-radius: var(--radius-m); padding: 0 16px; margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        input, select, textarea { 
            width: 100%; padding: 16px 0; border: none; border-bottom: 0.5px solid var(--separator); 
            box-sizing: border-box; font-size: 17px; outline: none; font-family: inherit; background: transparent; color: var(--text);
            -webkit-appearance: none;
        }
        input:last-child, select:last-child, textarea:last-child { border-bottom: none; }
        textarea { resize: vertical; height: 100px; }
        input::placeholder, textarea::placeholder { color: var(--text-secondary); }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: var(--radius-m); font-weight: 600; cursor: pointer; font-size: 17px; margin-bottom: 12px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        .btn-sec { background: rgba(142, 142, 147, 0.2); color: var(--text); }
        .btn-danger { background: var(--accent); color: white; }

        /* BOTONES FOTO IOS */
        .photo-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .btn-photo { 
            background: var(--card); border: none; border-radius: var(--radius-m); 
            padding: 20px; cursor: pointer; font-size: 1rem; color: var(--primary); 
            display: flex; flex-direction: column; align-items: center; gap: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-photo:active { background: #E5E5EA; transform: scale(0.97); }
        .btn-photo span { font-size: 2rem; }
        .uploading-state { opacity: 0.5; pointer-events: none; }

        /* --- UI PRINCIPAL --- */
        /* Categor√≠as (Pills) */
        .cat-bar { display: flex; overflow-x: auto; padding: 15px 15px 5px 15px; gap: 12px; background: var(--bg); -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .cat-bar::-webkit-scrollbar { display: none; }
        .cat-pill { 
            background: rgba(142, 142, 147, 0.12); padding: 10px 20px; border-radius: 20px; 
            font-weight: 600; color: var(--text); white-space: nowrap; cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        .cat-pill.active { background: var(--text); color: var(--card); }

        /* Grilla Productos */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .card { 
            background: var(--card); border-radius: var(--radius-l); overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; display: flex; flex-direction: column;
            transition: transform 0.2s ease;
        }
        .card:active { transform: scale(0.97); }
        .card.no-stock { opacity: 0.6; }
        
        .img-box { width: 100%; aspect-ratio: 1/1; background: #f0f0f0; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .badge { position: absolute; top: 10px; left: 10px; padding: 6px 10px; border-radius: var(--radius-s); font-size: 0.7rem; font-weight: 800; color: white; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        .bg-promo { background: var(--accent); }
        .bg-stock { background: rgba(0,0,0,0.7); top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.9rem; }

        .card-actions { position: absolute; top: 10px; right: 10px; display: none; gap: 8px; z-index: 10; }
        .admin-visible .card-actions { display: flex; }
        .act-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); color: var(--text); }
        .btn-del { color: var(--accent); }

        .info { padding: 12px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; color: var(--text); line-height: 1.2; }
        .desc-text { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .prices { margin-top: auto; padding-top: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }
        .old { text-decoration: line-through; color: var(--text-secondary); font-size: 0.9rem; }
        .curr { color: var(--text); font-weight: 800; font-size: 1.2rem; }
        .promo { color: var(--accent); }
        
        .add-btn-floating {
            position: absolute; bottom: 10px; right: 10px;
            width: 32px; height: 32px; border-radius: 50%; background: var(--text); color: white;
            border: none; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .card.no-stock .add-btn-floating { background: var(--text-secondary); }

        /* --- CARRITO FLOTANTE (Estilo Dock iOS) --- */
        .cart-dock { 
            position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); 
            background: rgba(25, 25, 25, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            color: white; padding: 16px 30px; border-radius: 40px; display: flex; align-items: center; gap: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); cursor: pointer; width: 85%; max-width: 400px; justify-content: space-between; z-index: 500; 
            transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .cart-dock:active { transform: translateX(-50%) scale(0.97); }
        .cart-info { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 1.1rem; }
        .cart-total { font-weight: 800; font-size: 1.3rem; }

        /* --- MODALES (Bottom Sheet Style) --- */
        .modal-overlay, .login-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2500; justify-content: center; align-items: flex-end; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
        .modal-body, .login-box { 
            background: var(--card); width: 100%; max-width: 600px; 
            border-radius: 24px 24px 0 0; padding: 30px 25px calc(30px + env(safe-area-inset-bottom)) 25px; 
            max-height: 85vh; overflow-y: auto; box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 1.6rem; font-weight: 800; margin: 0; }
        .close-modal { background: #E5E5EA; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Cart Rows */
        .cart-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 0.5px solid var(--separator); padding-bottom: 15px; font-size: 1.1rem; }
        .cart-row b { font-weight: 700; }
        
        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }

    </style>
</head>
<body id="mainBody">

    <div id="loader"><div class="spinner"></div><p id="loaderMsg" style="margin-top:20px; color:var(--text-secondary); font-weight:600;">Iniciando...</p></div>

    <header>
        <button class="header-btn menu-icon" onclick="toggleMenu()">‚ò∞</button>
        <div class="brand">Mi Tienda</div>
        <button class="header-btn" onclick="checkLoginAccess()">Admin</button>
    </header>

    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            Men√∫
            <button class="close-menu" onclick="toggleMenu()">‚úï</button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-group" id="sidebarList">
                </div>
        </div>
        <div class="sidebar-footer">
            <a href="#" class="contact-link wa" id="waContact" target="_blank">üí¨ WhatsApp</a>
            <a href="#" class="contact-link ig" id="igContact" target="_blank">üì∑ Instagram</a>
        </div>
    </div>

    <div class="login-overlay" id="loginModal">
        <div class="login-box" id="loginFormBox">
            <div class="modal-header"><h3 class="modal-title">Acceso Admin</h3><button class="close-modal" onclick="closeLogin()">‚úï</button></div>
            <div class="form-group">
                <input type="text" id="loginUser" placeholder="Usuario">
                <input type="password" id="loginPass" placeholder="Contrase√±a">
            </div>
            <button class="btn-main" onclick="doLogin()">Entrar</button>
        </div>
        <div class="login-box" id="changePassBox" style="display:none;">
             <div class="modal-header"><h3 class="modal-title">Cambiar Clave</h3><button class="close-modal" onclick="togglePassMode(false)">‚úï</button></div>
            <div class="form-group">
                <input type="password" id="oldPass" placeholder="Clave Actual">
                <input type="password" id="newPass" placeholder="Nueva Clave">
                <input type="password" id="confirmPass" placeholder="Confirmar">
            </div>
            <button class="btn-main" onclick="saveNewPass()">Guardar Nueva Clave</button>
        </div>
    </div>

    <div id="adminPanel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding: 0 10px;">
            <h2 id="formTitle" style="margin:0; font-size:1.8rem; font-weight:800;">Nuevo Producto</h2>
            <button class="header-btn" onclick="togglePassMode(true)" style="font-size:1rem;">Clave</button>
        </div>

        <input type="hidden" id="editId">
        
        <div class="form-group">
            <input type="text" id="pName" placeholder="Nombre del Producto">
            <textarea id="pDesc" placeholder="Descripci√≥n (Ingredientes, detalles...)"></textarea>
        </div>
        
        <div class="form-group">
            <div class="form-row">
                <input type="number" id="pPrice" placeholder="Precio ($)">
                <input type="number" id="pPromo" placeholder="Promo (Opcional)">
            </div>
        </div>

        <div class="photo-buttons" id="uploadWrapper">
            <button class="btn-photo" onclick="document.getElementById('fileInputCam').click()"><span>üì∑</span> C√°mara</button>
            <button class="btn-photo" onclick="document.getElementById('fileInputGal').click()"><span>üñºÔ∏è</span> Galer√≠a</button>
        </div>
        <div id="uploadStatus" style="text-align:center; font-size:0.9rem; margin-bottom:20px; color:var(--text-secondary);">Toca para subir foto</div>

        <input type="file" id="fileInputCam" accept="image/*" capture="environment" onchange="uploadToDrive(this)" style="display:none;">
        <input type="file" id="fileInputGal" accept="image/*" onchange="uploadToDrive(this)" style="display:none;">
        <input type="hidden" id="pImg">

        <div class="form-group">
            <input type="text" id="pCat" placeholder="Categor√≠a (Ej: Remeras)" list="catDatalist">
            <select id="pStock" style="color:var(--primary); font-weight:600;"><option value="SI">‚úÖ Hay Stock</option><option value="NO">‚ùå Sin Stock</option></select>
        </div>
        <datalist id="catDatalist"></datalist>

        <button class="btn-main" onclick="saveProductToServer()" id="btnSave" style="margin-top:20px;">Guardar Producto</button>
        <button class="btn-main btn-sec" onclick="cancelEdit()" id="btnCancel" style="display:none">Cancelar Edici√≥n</button>
        <button class="btn-main btn-danger" onclick="logout()" style="margin-top:20px;">Cerrar Sesi√≥n</button>
    </div>

    <div class="cat-bar" id="catContainer"></div>
    <div class="grid" id="grid"></div>

    <div class="cart-dock" id="cartBtn" onclick="openCart()" style="display:none;">
        <div class="cart-info"><span>üõçÔ∏è</span> <span id="cartCount">0</span> items</div>
        <div class="cart-total" id="cartTotal">$0</div>
    </div>

    <div class="modal-overlay" id="cartModal" onclick="if(event.target===this)closeCart()">
        <div class="modal-body">
            <div class="modal-header"><h2 class="modal-title">Tu Pedido</h2><button class="close-modal" onclick="closeCart()">‚úï</button></div>
            <div id="cartList"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:20px;">
                 <span style="font-size:1.3rem; color:var(--text-secondary);">Total a pagar:</span>
                 <span id="modalTotal" style="font-size:2rem; font-weight:800;">$0</span>
            </div>
            <a href="#" id="waLink" class="btn-main wa-btn" target="_blank" style="text-decoration:none; display:flex; justify-content:center; align-items:center; background:#25D366;">Enviar Pedido por WhatsApp</a>
            <button onclick="clearCart()" class="btn-main btn-sec" style="background:transparent; color:var(--text-secondary); margin-top:10px;">Vaciar Carrito</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxMUSMKycILcGWQVbUbAy7MtgvvvWhM0-QdlMdp4sXxirDHKz-LvaQgaYuku3Td8puS4Q/exec";
        const PHONE = "5491138614767"; 
        const INSTAGRAM_URL = "https://instagram.com/"; // PON TU IG AQUI

        let products = [], cart = [], activeCat = 'all';
        let isLoggedIn = false;

        function getCreds() { const s = localStorage.getItem('shop_creds'); return s ? JSON.parse(s) : { u: 'LUCAS', p: 'FAGA' }; }
        
        // MEN√ö LATERAL
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('menuOverlay').classList.toggle('open');
        }

        // LOGIN
        function checkLoginAccess() { 
            if (isLoggedIn) {
                document.getElementById('mainBody').classList.toggle('admin-visible');
                 window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                document.getElementById('loginModal').style.display='flex';
                document.getElementById('loginFormBox').style.display='block';
                document.getElementById('changePassBox').style.display='none';
            }
        }
        function doLogin() {
            const u = document.getElementById('loginUser').value, p = document.getElementById('loginPass').value, c = getCreds();
            if (u === c.u && p === c.p) { isLoggedIn = true; closeLogin(); document.getElementById('mainBody').classList.add('admin-visible'); window.scrollTo(0,0); } else alert("Datos incorrectos");
        }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }
        function logout() { isLoggedIn = false; document.getElementById('mainBody').classList.remove('admin-visible'); alert("Sesi√≥n cerrada"); }
        function togglePassMode(show) { document.getElementById('loginFormBox').style.display = show?'none':'block'; document.getElementById('changePassBox').style.display = show?'block':'none'; }
        function saveNewPass() {
            const o = document.getElementById('oldPass').value, n = document.getElementById('newPass').value, c = document.getElementById('confirmPass').value, r = getCreds();
            if (o !== r.p) return alert("Clave actual mal"); if (n !== c) return alert("No coinciden"); if (n.length<4) return alert("Muy corta");
            localStorage.setItem('shop_creds', JSON.stringify({ u: 'LUCAS', p: n })); alert("Listo!"); closeLogin();
        }

        // FOTOS
        function uploadToDrive(inputElement) {
            const file = inputElement.files[0]; const status = document.getElementById('uploadStatus'); const btns = document.querySelectorAll('.btn-photo');
            if(!file) return; if(file.size > 5 * 1024 * 1024) return alert("M√°ximo 5MB.");
            status.innerText = "Subiendo..."; status.style.fontWeight = "600"; status.style.color = "var(--primary)";
            btns.forEach(b => b.classList.add('uploading-state'));

            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64Content = reader.result.split(',')[1]; 
                try {
                    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "uploadImage", image: base64Content, mimeType: file.type, filename: file.name }) });
                    const data = await res.json();
                    if(data.result === "success") { document.getElementById('pImg').value = data.url; status.innerText = "‚úÖ Foto lista"; status.style.color = "#34C759"; } else throw new Error(data.message);
                } catch(e) { status.innerText = "‚ùå Error"; status.style.color = "var(--accent)"; alert("Error: " + e); } finally { btns.forEach(b => b.classList.remove('uploading-state')); }
            };
        }

        // LOGICA TIENDA
        async function init() {
            showLoader(true);
            document.getElementById('waContact').href = `https://wa.me/${PHONE}`;
            document.getElementById('igContact').href = INSTAGRAM_URL;
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                products = data.products || [];
                renderCats(); renderGrid('all');
            } catch (err) { console.error(err); alert("Error de conexi√≥n"); } finally { showLoader(false); }
        }

        async function saveProductToServer() {
            const imgVal = document.getElementById('pImg').value;
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            if (!name || !price) return alert("Falta nombre o precio"); if (!imgVal) return alert("Falta la foto");
            const payload = {
                action: document.getElementById('editId').value ? "edit" : "add",
                id: document.getElementById('editId').value || Date.now(),
                name: name, price: price, promo: document.getElementById('pPromo').value,
                img: imgVal, cat: document.getElementById('pCat').value || "Varios",
                stock: document.getElementById('pStock').value, desc: document.getElementById('pDesc').value 
            };
            showLoader(true, "Guardando...");
            try { await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }); cancelEdit(); await init(); } catch (err) { alert("Error al guardar"); } finally { showLoader(false); }
        }

        async function deleteProduct(id) {
            if(!confirm("¬øBorrar?")) return; showLoader(true, "Borrando...");
            try { await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "delete", id: id }) }); await init(); } catch(e) { alert("Error"); } finally { showLoader(false); }
        }

        function showLoader(show, msg) { if(msg) document.getElementById('loaderMsg').innerText = msg; document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
        
        function renderCats() {
            const cats = ['Todos', ...new Set(products.map(p => p.cat))];
            const c = document.getElementById('catContainer'); const dl = document.getElementById('catDatalist'); const sb = document.getElementById('sidebarList');
            c.innerHTML = ''; dl.innerHTML = ''; sb.innerHTML = '';
            
            cats.forEach(x => { 
                const isActive = activeCat === x;
                const cls = isActive ? 'active' : '';
                c.innerHTML += `<div class="cat-pill ${cls}" onclick="filter('${x==='Todos'?'all':x}')">${x}</div>`;
                sb.innerHTML += `<div class="sidebar-item ${cls}" onclick="filter('${x==='Todos'?'all':x}'); toggleMenu()">${x}</div>`;
                if(x!=='Todos') dl.innerHTML += `<option value="${x}">`; 
            });
        }
        
        function filter(c) { activeCat=c; renderCats(); renderGrid(c); }
        
        function renderGrid(c) {
            const g = document.getElementById('grid'); g.innerHTML = '';
            const list = c === 'all' ? products : products.filter(p => p.cat === c);
            if(list.length === 0) { g.innerHTML = '<p style="text-align:center;width:100%;color:var(--text-secondary);grid-column:1/-1;padding:40px;">No hay productos aqu√≠.</p>'; return; }
            list.forEach(p => {
                const isPromo = p.promoPrice && p.promoPrice < p.price;
                g.innerHTML += `
                <div class="card ${!p.hasStock?'no-stock':''}">
                    <div class="card-actions"><button class="act-btn" onclick='editP(${JSON.stringify(p)})'>‚úèÔ∏è</button><button class="act-btn btn-del" onclick="deleteProduct(${p.id})">üóëÔ∏è</button></div>
                    <div class="img-box">${isPromo?'<span class="badge bg-promo">OFERTA</span>':''}${!p.hasStock?'<span class="badge bg-stock">AGOTADO</span>':''}<img src="${p.img}" onerror="this.src='https://via.placeholder.com/150?text=Error'"></div>
                    <div class="info"><div class="card-title">${p.name}</div>${p.desc ? `<div class="desc-text">${p.desc}</div>` : ''}
                    <div class="prices">${isPromo ? `<span class="old">$${p.price}</span> <span class="curr promo">$${p.promoPrice}</span>` : `<span class="curr">$${p.price}</span>`}</div>
                    <button class="add-btn-floating" onclick="addCart(${p.id})" ${!p.hasStock?'disabled':''}>${p.hasStock?'+':'‚úï'}</button>
                    </div>
                </div>`;
            });
        }
        
        function editP(p) {
            if(!isLoggedIn) return checkLoginAccess();
            document.getElementById('editId').value = p.id;
            document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pPromo').value = p.promoPrice||'';
            document.getElementById('pImg').value = p.img; document.getElementById('pCat').value = p.cat; document.getElementById('pStock').value = p.hasStock?'SI':'NO'; document.getElementById('pDesc').value = p.desc || ''; 
            document.getElementById('uploadStatus').innerText = "‚úÖ Foto actual OK"; document.getElementById('uploadStatus').style.color = "#34C759";
            document.getElementById('btnSave').innerText = "Actualizar Producto"; document.getElementById('btnCancel').style.display = 'block'; document.getElementById('formTitle').innerText = "Editar Producto";
            document.getElementById('mainBody').classList.add('admin-visible'); window.scrollTo(0,0);
        }
        
        function cancelEdit() {
            document.getElementById('editId').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pPromo').value = '';
            document.getElementById('pImg').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('fileInputCam').value = ""; document.getElementById('fileInputGal').value = "";
            document.getElementById('uploadStatus').innerText = "Toca para subir foto"; document.getElementById('uploadStatus').style.color = "var(--text-secondary)";
            document.getElementById('btnSave').innerText = "Guardar Producto"; document.getElementById('btnCancel').style.display = 'none'; document.getElementById('formTitle').innerText = "Nuevo Producto";
        }
        
        function addCart(id) { const p = products.find(x=>x.id==id); if(p&&p.hasStock){ cart.push(p); updateCart(); } }
        function updateCart() {
            const t = cart.reduce((a,b)=>a+(b.promoPrice||b.price),0);
            document.getElementById('cartCount').innerText = cart.length; document.getElementById('cartTotal').innerText = '$'+t; document.getElementById('modalTotal').innerText = '$'+t;
            document.getElementById('cartBtn').style.display = cart.length?'flex':'none';
        }
        function openCart() {
            const l = document.getElementById('cartList'); l.innerHTML = ''; const g = {}; cart.forEach(i=>{ if(!g[i.id])g[i.id]={...i,q:0}; g[i.id].q++; });
            let msg = "üëã Hola! Pedido:%0A%0A"; Object.values(g).forEach(i=>{ const pr = i.promoPrice||i.price; l.innerHTML+=`<div class="cart-row"><span>${i.name} (x${i.q})</span><b>$${pr*i.q}</b></div>`; msg+=`‚Ä¢ *${i.q}x ${i.name}*: $${pr*i.q}%0A`; });
            msg+=`%0ATotal: $${cart.reduce((a,b)=>a+(b.promoPrice||b.price),0)}`;
            document.getElementById('waLink').href=`https://wa.me/${PHONE}?text=${msg}`;
            document.getElementById('cartModal').style.display='flex';
        }
        function closeCart(){document.getElementById('cartModal').style.display='none';}
        function clearCart(){cart=[];updateCart();closeCart();}
        init();
    </script>
</body>
</html>
